import{c as l,d as S}from"./chunk-TO6NF34E.js";import{c as h,d as y}from"./chunk-OFH4QNJH.js";import{a as f,b as u,c as o}from"./chunk-POLL2CVR.js";import{CommonModule as D}from"@angular/common";import"@angular/core";import{inject as P}from"@angular/core";import{first as b,map as A,switchMap as _,tap as F}from"rxjs";var d={APPEARANCE:{theme:"stripe"},OPTIONS:{layout:{type:"accordion",defaultCollapsed:!0,radios:!0,spacedAccordionItems:!1}}};import{CommonModule as L}from"@angular/common";import"@angular/core";import{BehaviorSubject as I,of as R}from"rxjs";import*as a from"@angular/core";var v=(()=>{class i{get stripeRef(){return this._stripeRef$.getValue()}constructor(t){this.utilsSrv=t,this._stripeRef$=new I(null),this.stripeRef$=this._stripeRef$.asObservable()}get(){return this.stripeRef?R(this.stripeRef):(this.init(),this.stripeRef$)}init(){this.utilsSrv.isPlatformBrowser&&typeof window.Stripe>"u"&&this.utilsSrv.loadScript(l.stripe.URL,this.loadSDK.bind(this))}loadSDK(){this._stripeRef$.next(window.Stripe(l.stripe.code))}static{this.\u0275fac=function(r){return new(r||i)(a.\u0275\u0275inject(h))}}static{this.\u0275prov=a.\u0275\u0275defineInjectable({token:i,factory:i.\u0275fac,providedIn:"root"})}}return i})();var p=function(i){return i.CARD="card",i.IDEAL="ideal",i.SEPA="sepa",i.PAYPAL="paypal",i.CREDITS="credits",i.APPLE_PAY="applePay",i.KLARNA="klarna",i.ELEMENTS="elements",i}(p||{});import"@angular/core";import{map as E}from"rxjs";import*as m from"@angular/core";var g=(()=>{class i extends S{createSecret(t){return this.Get(`payments/secret/stripe/${t}`).pipe(E(r=>r.data))}createIntent(t){return this.Post("payments/intent/stripe",u(f({},t),{platform:"web"})).pipe(E(r=>r.data))}static{this.\u0275fac=(()=>{let t;return function(n){return(t||(t=m.\u0275\u0275getInheritedFactory(i)))(n||i)}})()}static{this.\u0275prov=m.\u0275\u0275defineInjectable({token:i,factory:i.\u0275fac,providedIn:"root"})}}return i})();import*as e from"@angular/core";import*as C from"@angular/common";var x=["stripeElementsRef"];function $(i,j){i&1&&(e.\u0275\u0275elementContainerStart(0),e.\u0275\u0275text(1," Loading... "),e.\u0275\u0275elementContainerEnd())}var w=(()=>{class i extends y{constructor(){super(...arguments),this.stripeSrv=P(v),this.stripeApiSrv=P(g),this.isReady=!1,this.canPay=!1}ngAfterViewInit(){this.stripeSrv.get().pipe(b(t=>!!t),F(t=>this.stripe=t),_(()=>this.getClientSecret())).subscribe(t=>{try{let r=d.APPEARANCE,n=d.OPTIONS;this.clientSecret=t,this.elements=this.stripe.elements({appearance:r,clientSecret:t}),this.paymentElement=this.elements.create("payment",n),this.paymentElement.mount(this.stripeElementsRef.nativeElement),this.paymentElement.on("ready",()=>{this.isReady=!0,this.listenElementsDataChanges()})}catch(r){console.error(r)}})}submitForm(){return o(this,null,function*(){try{let{error:t}=yield this.elements.submit();if(t)throw t;let r=this.getConfirmData();this.isSetup?yield this.attachPaymentMethod(r):yield this.pay(r)}catch(t){console.error(t)}})}pay(t){return o(this,null,function*(){let{error:r}=yield this.stripe.confirmPayment(t);if(r)throw r})}attachPaymentMethod(t){return o(this,null,function*(){let{setupIntent:r,error:n}=yield this.stripe.confirmSetup(t);if(n)throw n})}getClientSecret(){return(this.isSetup?this.stripeApiSrv.createSecret(p.ELEMENTS):this.getPaymentIntent()).pipe(A(({client_secret:r})=>r))}getPaymentIntent(){let t={amount:this.amount,customer:this.state.user().paymentMethods[0].id,methodTypes:p.ELEMENTS,currency:this.currency};return this.stripeApiSrv.createIntent(t)}listenElementsDataChanges(){this.paymentElement.on("change",t=>{this.canPay=t.complete,this.selectedPaymentMethod=t.value.type})}getConfirmData(){let t=window.location.href,r=t.includes("?"),n=`${t}${r?"&":"?"}selected_payment_method=${this.selectedPaymentMethod}`;return{elements:this.elements,clientSecret:this.clientSecret,redirect:"if_required",confirmParams:{return_url:n}}}static{this.\u0275fac=(()=>{let t;return function(n){return(t||(t=e.\u0275\u0275getInheritedFactory(i)))(n||i)}})()}static{this.\u0275cmp=e.\u0275\u0275defineComponent({type:i,selectors:[["app-stripe-elements"]],viewQuery:function(r,n){if(r&1&&e.\u0275\u0275viewQuery(x,7),r&2){let c;e.\u0275\u0275queryRefresh(c=e.\u0275\u0275loadQuery())&&(n.stripeElementsRef=c.first)}},inputs:{isSetup:"isSetup",amount:"amount",currency:"currency"},standalone:!0,features:[e.\u0275\u0275InheritDefinitionFeature,e.\u0275\u0275StandaloneFeature],decls:7,vars:4,consts:[[4,"ngIf"],["id","payment-form",3,"hidden"],["id","payment-element"],["stripeElementsRef",""],[1,"mt-4"],[1,"w-100",3,"disabled","click"]],template:function(r,n){r&1&&(e.\u0275\u0275template(0,$,2,0,"ng-container",0),e.\u0275\u0275elementStart(1,"form",1),e.\u0275\u0275element(2,"div",2,3),e.\u0275\u0275elementStart(4,"div",4)(5,"button",5),e.\u0275\u0275listener("click",function(){return n.canPay&&n.submitForm()}),e.\u0275\u0275text(6),e.\u0275\u0275elementEnd()()()),r&2&&(e.\u0275\u0275property("ngIf",!n.isReady),e.\u0275\u0275advance(),e.\u0275\u0275property("hidden",!n.isReady),e.\u0275\u0275advance(4),e.\u0275\u0275property("disabled",!n.canPay),e.\u0275\u0275advance(),e.\u0275\u0275textInterpolate1(" ",n.isSetup?"Add":"Pay now"," "))},dependencies:[L,C.NgIf],styles:[".tst[_ngcontent-%COMP%]{color:#000}"]})}}return i})();import*as s from"@angular/core";var de=(()=>{class i{static{this.\u0275fac=function(r){return new(r||i)}}static{this.\u0275cmp=s.\u0275\u0275defineComponent({type:i,selectors:[["app-payment-page"]],standalone:!0,features:[s.\u0275\u0275StandaloneFeature],decls:4,vars:1,consts:[[1,"container","py-5"],[1,"row","justify-content-center"],[1,"col-xl-5"],[3,"isSetup"]],template:function(r,n){r&1&&(s.\u0275\u0275elementStart(0,"div",0)(1,"div",1)(2,"div",2),s.\u0275\u0275element(3,"app-stripe-elements",3),s.\u0275\u0275elementEnd()()()),r&2&&(s.\u0275\u0275advance(3),s.\u0275\u0275property("isSetup",!0))},dependencies:[D,w]})}}return i})();export{de as PaymentPageComponent};
